var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};
$jscomp.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");var $jscomp$lookupPolyfilledValue=function(a,b){var c=$jscomp.propertyToPolyfillSymbol[b];if(null==c)return a[b];c=a[c];return void 0!==c?c:a[b]};
$jscomp.polyfill=function(a,b,c,d){b&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(a,b,c,d):$jscomp.polyfillUnisolated(a,b,c,d))};$jscomp.polyfillUnisolated=function(a,b,c,d){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})};
$jscomp.polyfillIsolated=function(a,b,c,d){var e=a.split(".");a=1===e.length;d=e[0];d=!a&&d in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var f=0;f<e.length-1;f++){var g=e[f];g in d||(d[g]={});d=d[g]}e=e[e.length-1];c=$jscomp.IS_SYMBOL_NATIVE&&"es6"===c?d[e]:null;b=b(c);null!=b&&(a?$jscomp.defineProperty($jscomp.polyfills,e,{configurable:!0,writable:!0,value:b}):b!==c&&($jscomp.propertyToPolyfillSymbol[e]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(e):$jscomp.POLYFILL_PREFIX+e,e=$jscomp.propertyToPolyfillSymbol[e],
$jscomp.defineProperty(d,e,{configurable:!0,writable:!0,value:b})))};$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(a){function b(){this.batch_=null}function c(a){return a instanceof e?a:new e(function(b,c){b(a)})}if(a&&!$jscomp.FORCE_POLYFILL_PROMISE)return a;b.prototype.asyncExecute=function(a){if(null==this.batch_){this.batch_=[];var b=this;this.asyncExecuteFunction(function(){b.executeBatch_()})}this.batch_.push(a)};var d=$jscomp.global.setTimeout;b.prototype.asyncExecuteFunction=function(a){d(a,0)};b.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var a=
this.batch_;this.batch_=[];for(var b=0;b<a.length;++b){var c=a[b];a[b]=null;try{c()}catch(l){this.asyncThrow_(l)}}}this.batch_=null};b.prototype.asyncThrow_=function(a){this.asyncExecuteFunction(function(){throw a;})};var e=function(a){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var b=this.createResolveAndReject_();try{a(b.resolve,b.reject)}catch(k){b.reject(k)}};e.prototype.createResolveAndReject_=function(){function a(a){return function(e){c||(c=!0,a.call(b,e))}}var b=this,c=!1;
return{resolve:a(this.resolveTo_),reject:a(this.reject_)}};e.prototype.resolveTo_=function(a){if(a===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(a instanceof e)this.settleSameAsPromise_(a);else{a:switch(typeof a){case "object":var b=null!=a;break a;case "function":b=!0;break a;default:b=!1}b?this.resolveToNonPromiseObj_(a):this.fulfill_(a)}};e.prototype.resolveToNonPromiseObj_=function(a){var b=void 0;try{b=a.then}catch(k){this.reject_(k);return}"function"==typeof b?
this.settleSameAsThenable_(b,a):this.fulfill_(a)};e.prototype.reject_=function(a){this.settle_(2,a)};e.prototype.fulfill_=function(a){this.settle_(1,a)};e.prototype.settle_=function(a,b){if(0!=this.state_)throw Error("Cannot settle("+a+", "+b+"): Promise already settled in state"+this.state_);this.state_=a;this.result_=b;this.executeOnSettledCallbacks_()};e.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var a=0;a<this.onSettledCallbacks_.length;++a)f.asyncExecute(this.onSettledCallbacks_[a]);
this.onSettledCallbacks_=null}};var f=new b;e.prototype.settleSameAsPromise_=function(a){var b=this.createResolveAndReject_();a.callWhenSettled_(b.resolve,b.reject)};e.prototype.settleSameAsThenable_=function(a,b){var c=this.createResolveAndReject_();try{a.call(b,c.resolve,c.reject)}catch(l){c.reject(l)}};e.prototype.then=function(a,b){function c(a,b){return"function"==typeof a?function(b){try{d(a(b))}catch(m){f(m)}}:b}var d,f,g=new e(function(a,b){d=a;f=b});this.callWhenSettled_(c(a,d),c(b,f));return g};
e.prototype.catch=function(a){return this.then(void 0,a)};e.prototype.callWhenSettled_=function(a,b){function c(){switch(d.state_){case 1:a(d.result_);break;case 2:b(d.result_);break;default:throw Error("Unexpected state: "+d.state_);}}var d=this;null==this.onSettledCallbacks_?f.asyncExecute(c):this.onSettledCallbacks_.push(c)};e.resolve=c;e.reject=function(a){return new e(function(b,c){c(a)})};e.race=function(a){return new e(function(b,d){for(var e=$jscomp.makeIterator(a),f=e.next();!f.done;f=e.next())c(f.value).callWhenSettled_(b,
d)})};e.all=function(a){var b=$jscomp.makeIterator(a),d=b.next();return d.done?c([]):new e(function(a,e){function f(b){return function(c){g[b]=c;h--;0==h&&a(g)}}var g=[],h=0;do g.push(void 0),h++,c(d.value).callWhenSettled_(f(g.length-1),e),d=b.next();while(!d.done)})};return e},"es6","es3");$jscomp.polyfill("globalThis",function(a){return a||$jscomp.global},"es_2020","es3");
var ANIMATION_FRAME_DURATION_MS=300,CASE_GRAPH_WIDTH_PX=200,CASE_GRAPH_HEIGHT_PX=120,COLOR_MAP=[["#67009e","< 10",10],["#921694","11\u2013100",100],["#d34d60","101\u2013500",500],["#fb9533","501\u20132000",2E3],["#edf91c","> 2000"],["cornflowerblue","New"]],MAPBOX_TOKEN="pk.eyJ1IjoiaGVhbHRobWFwIiwiYSI6ImNrOGl1NGNldTAyYXYzZnBqcnBmN3RjanAifQ.H377pe4LPPcymeZkUBiBtg",ZOOM_THRESHOLD=2,timestamp=(new Date).getTime(),locationInfo={},countryNames={},latestDataPerCountry={},dates=[],dataSliceFileNames=[],
map,popup,currentIsoDate,animationIntervalId=0,countryFeaturesByDay={},provinceFeaturesByDay={},atomicFeaturesByDay={},timeControl;function onMapZoomChanged(){showDataAtDate(currentIsoDate)}
function showDataAtDate(a){currentIsoDate!=a&&(currentIsoDate=a);var b=[];if(map.getZoom()<=ZOOM_THRESHOLD&&currentIsoDate==dates[dates.length-1])for(var c in latestDataPerCountry)a=formatFeatureForMap({properties:{geoid:c,total:latestDataPerCountry[c][1],"new":0}}),b.push(a);else b=atomicFeaturesByDay[a];map.getSource("counts").setData(formatFeatureSetForMap(b))}function setTimeControlLabel(a){document.getElementById("date").innerText=dates[a]}
function updateTimeControl(){2>dates.length||(document.getElementById("range-slider").style.display="flex",timeControl.min=0,timeControl.max=dates.length-1,timeControl.value=dates.length-1,setTimeControlLabel(dates.length-1))}
function toggleMapAnimation(){var a=!animationIntervalId;document.getElementById("playpause").setAttribute("src","img/"+(a?"pause":"play")+".svg");if(a){var b=0;animationIntervalId=setInterval(function(){timeControl.value=b;showDataAtDate(dates[b]);setTimeControlLabel(b);b++;b===dates.length&&toggleMapAnimation()},ANIMATION_FRAME_DURATION_MS)}else clearInterval(animationIntervalId),animationIntervalId=0}function zfill(a,b){a+="";return a.length>=b?a:Array(b-a.length+1).join("0")+a}
function processDailySlice(a,b){var c=a.date;a=a.features;for(var d={},e={},f=0;f<a.length;f++){var g=formatFeatureForMap(a[f]);if(locationInfo[g.properties.geoid]){var h=locationInfo[g.properties.geoid].split(",");d[h[1]]||(d[h[1]]={total:0,"new":0});d[h[1]].total+=g.properties.total;d[h[1]]["new"]+=g.properties["new"];e[h[2]]||(e[h[2]]={total:0,"new":0});e[h[2]].total+=g.properties.total;e[h[2]]["new"]+=g.properties["new"]}}dates.unshift(c);countryFeaturesByDay[c]=e;provinceFeaturesByDay[c]=d;atomicFeaturesByDay[c]=
a;b&&showDataAtDate(c);updateTimeControl()}function fetchDailySlice(a,b){a="dailies/"+a;b&&(a+="?nocache="+timestamp);return fetch(a).then(function(a){return a.json()}).then(function(a){a&&processDailySlice(a,b)})}function onBasicDataFetched(){for(var a=[],b=0;b<dataSliceFileNames.length;b++)a.push(fetchDailySlice(dataSliceFileNames[b],0==b));Promise.all(a).then(onAllDailySlicesFetched)}function onAllDailySlicesFetched(){dates=dates.sort()}
function formatFeatureSetForMap(a){return{type:"FeatureCollection",features:a}}function formatFeatureForMap(a){a.type="Feature";a.properties||(a.properties={geoid:"0|0"});isNaN(a.properties["new"])&&(a.properties["new"]=0);var b=a.properties.geoid.split("|");a.geometry={type:"Point",coordinates:[b[1],b[0]]};return a}
function fetchJhuData(){return fetch("jhu.json?nocache="+timestamp).then(function(a){return a.json()}).then(function(a){a=a.features;var b="";a.sort(function(a,b){return b.attributes.cum_conf-a.attributes.cum_conf});for(var c=0;c<a.length;++c){var d=a[c];if(d&&d.attributes&&d.centroid){var e=d.attributes.ADM0_NAME||"",f=d.centroid.x||0,g=d.centroid.y||0,h=""+g+"|"+f;d=parseInt(d.attributes.cum_conf.replace(/,/g,""),10)||0;var k="default";latestDataPerCountry[h]=[e,d];locationInfo[h]=",,"+e;10>=d?
k="10":100>=d?k="100":500>=d?k="500":2E3>=d&&(k="2000");b+='<li><button onClick="handleFlyTo('+f+","+g+',4)"><span class="label">'+e+'</span><span class="num legend-group-'+k+'">'+d.toLocaleString()+"</span></span></button></li>"}}document.getElementById("location-list").innerHTML=b})}function fetchLocationData(){return fetch("location_info.data").then(function(a){return a.text()}).then(function(a){a=a.split("\n");for(var b=0;b<a.length;b++){var c=a[b].split(":");locationInfo[c[0]]=c[1]}})}
function fetchDataIndex(){return fetch("dailies/index.txt").then(function(a){return a.text()}).then(function(a){a=a.split("\n");for(var b=0;b<a.length;b++){var c=a[b].trim();c&&dataSliceFileNames.push(c)}})}function fetchCountryNames(){return fetch("countries.data").then(function(a){return a.text()}).then(function(a){a=a.trim().split("|");for(var b=0;b<a.length;b++){var c=a[b].split(":");countryNames[c[1]]=c[0]}})}
function fetchLatestCounts(){return fetch("latestCounts.json?nocache="+timestamp).then(function(a){return a.json()}).then(function(a){document.getElementById("total-cases").innerText=a[0].caseCount;document.getElementById("last-updated-date").innerText=a[0].date})}
function filterList(){var a=document.getElementById("location-filter").value.toUpperCase();document.getElementById("location-list");for(var b=document.getElementById("location-list").getElementsByTagName("li"),c=document.getElementById("clear-filter"),d=0;d<b.length;++d){var e=b[d].getElementsByClassName("label")[0];e=e.textContent||e.innerText;c.style.display=a?"flex":"none";e=-1!=e.toUpperCase().indexOf(a);b[d].style.display=e?"list-item":"none"}}
function clearFilter(){document.getElementById("location-filter").value="";filterList()}function fetchAboutPage(){fetch("about.html").then(function(a){return a.text()}).then(function(a){handleShowModal(a)})}function handleShowModal(a){var b=document.getElementById("modal"),c=document.getElementById("modal-wrapper");c.classList.add("is-block");b.classList.add("is-flex");setTimeout(function(){c.classList.add("is-visible");b.classList.add("is-visible")},40);b.innerHTML=a}
function handleHideModal(){var a=document.getElementById("modal"),b=document.getElementById("modal-wrapper");b.classList.remove("is-visible");a.classList.remove("is-visible");setTimeout(function(){b.classList.remove("is-block");a.classList.add("is-flex")},400)}
function showLegend(){for(var a=document.getElementById("legend").getElementsByTagName("ul")[0],b=0;b<COLOR_MAP.length;b++){var c=COLOR_MAP[b],d=document.createElement("li"),e=document.createElement("span");e.className="circle";e.style.backgroundColor=c[0];var f=document.createElement("span");f.className="label";f.textContent=c[1];d.appendChild(e);d.appendChild(f);a.appendChild(d)}}
function addMapLayer(a,b,c,d){a.addLayer({id:b,type:"circle",source:"counts",paint:{"circle-radius":["case",["<",0,["number",["get",c]]],["*",["log10",["sqrt",["get",c]]],10],0],"circle-color":d,"circle-opacity":.6}})}function sameLocation(a,b){return a==b}
function makeCaseGraph(a){var b=d3.select(document.createElementNS(d3.namespaces.svg,"svg"));b.attr("width",CASE_GRAPH_WIDTH_PX).attr("height",CASE_GRAPH_HEIGHT_PX);for(var c=[],d=0;d<dates.length;d++)for(var e=dates[d],f=atomicFeaturesByDay[e],g=0;g<f.length;g++){var h=f[g];sameLocation(a,h.properties.geoid)&&(h.properties.date=e,c.push({date:d3.timeParse("%Y-%m-%d")(e),total:h.properties.total}))}var k=d3.scaleTime().domain(d3.extent(c,function(a){return a.date})).range([0,CASE_GRAPH_WIDTH_PX]);
b.append("g").attr("transform","translate(0,"+CASE_GRAPH_HEIGHT_PX+")").call(d3.axisBottom(k).tickValues([]));var l=d3.scaleLinear().domain([0,d3.max(c,function(a){return a.total})]).range([CASE_GRAPH_HEIGHT_PX,0]);b.append("g").call(d3.axisLeft(l).tickValues([]));a=d3.line().x(function(a){return k(a.date)}).y(function(a){return l(a.total)});b.append("path").attr("d",a(c)).attr("fill","none").attr("stroke","steelblue").attr("stroke-width",1.5);return b.node()}
function showPopupForEvent(a){if(a.features.length){var b=a.features[0].properties,c=b.geoid,d=c.split("|"),e=parseFloat(d[0]);d=parseFloat(d[1]);var f="",g=0;map.getZoom()>ZOOM_THRESHOLD?(f=locationInfo[c].split(","),2==f[2].length&&(f[2]=countryNames[f[2]]),f=f.filter(function(a){return""!=a}),f=f.join(", "),g=b.total):(b=latestDataPerCountry[c],f=b[0],g=b[1]);b=document.createElement("div");b.innerHTML='<h3 class="popup-header">'+f+"</h3><div><strong>Number of Cases: </strong>"+g.toLocaleString()+
"</div>";for(map.getZoom()>ZOOM_THRESHOLD&&b.appendChild(makeCaseGraph(c));180<Math.abs(a.lngLat.lng-d);)d+=a.lngLat.lng>d?360:-360;popup.setLngLat([d,e]).setDOMContent(b).addTo(map)}}function handleFlyTo(a,b,c,d){map.flyTo({center:[a,b],zoom:c});window.scrollTo({top:0,left:0,behavior:"smooth"})}
function initMap(){mapboxgl.accessToken=MAPBOX_TOKEN;map=(new mapboxgl.Map({container:"map",style:"mapbox://styles/healthmap/ck7o47dgs1tmb1ilh5b1ro1vn",center:[10,0],zoom:1})).addControl(new mapboxgl.NavigationControl);popup=new mapboxgl.Popup({closeButton:!1,closeOnClick:!1});timeControl=document.getElementById("slider");timeControl.addEventListener("input",function(){setTimeControlLabel(timeControl.value);showDataAtDate(dates[timeControl.value])});map.on("load",function(){map.addSource("counts",
{type:"geojson",data:formatFeatureSetForMap([])});for(var a=["step",["get","total"]],b=0;b<COLOR_MAP.length-1;b++){var c=COLOR_MAP[b];a.push(c[0]);2<c.length&&a.push(c[2])}addMapLayer(map,"totals","total",a);addMapLayer(map,"daily","new","cornflowerblue");map.on("mouseenter","totals",function(a){map.getCanvas().style.cursor="pointer";showPopupForEvent(a)});map.on("zoom",onMapZoomChanged);map.on("mouseleave","totals",function(){map.getCanvas().style.cursor="";popup.remove()});Promise.all([fetchLatestCounts(),
fetchCountryNames(),fetchDataIndex(),fetchLocationData(),fetchJhuData()]).then(onBasicDataFetched);showLegend()});document.getElementById("spread").addEventListener("click",toggleMapAnimation);document.getElementById("playpause").setAttribute("src","img/play.svg")}"undefined"===typeof globalThis&&(globalThis=global);globalThis.clearFilter=clearFilter;globalThis.filterList=filterList;globalThis.initMap=initMap;globalThis.handleFlyTo=handleFlyTo;
